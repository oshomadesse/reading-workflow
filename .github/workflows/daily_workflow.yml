name: Daily Reading Workflow

on:
  schedule:
    # JST 07:00 -> UTC 22:00 (previous day)
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  run-workflow:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r src/requirements.txt

      - name: Create .env file
        run: |
          echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> .env
          echo "ANTHROPIC_API_KEY=${{ secrets.ANTHROPIC_API_KEY }}" >> .env
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
          echo "LINE_CHANNEL_ACCESS_TOKEN=${{ secrets.LINE_CHANNEL_ACCESS_TOKEN }}" >> .env
          echo "LINE_ENABLED=1" >> .env
          echo "LINE_TO=${{ secrets.LINE_USER_ID }}" >> .env
          # If you have other env vars like models, add them here or use defaults in code
          
          # Create google service account json from secret
          echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}' > service_account.json
          echo "GOOGLE_APPLICATION_CREDENTIALS=service_account.json" >> .env

      - name: Run Integrated Workflow
        env:
          # Force CI mode just in case, though GITHUB_ACTIONS is set by default
          GITHUB_ACTIONS: true
          PUBLIC_EXPORT_DIR: docs
          PUBLIC_BASE_URL: https://oshomadesse.github.io/books-summary/
          PUBLIC_GIT_AUTO_PUSH: 1
          PUBLIC_PAGES_WAIT_TIMEOUT: 300
        run: |
          export WORKFLOW_START_TIME=$(date +%s)
          python src/integrated_reading_workflow.py

      - name: Commit and Push changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add generated files
          git add data/ infographics/ docs/
          if [ -d "artifacts" ]; then git add artifacts/; fi
          
          # Commit if there are changes
          git commit -m "ðŸ¤– Daily Reading Workflow Update [skip ci]" || echo "No changes to commit"
          
          git push
